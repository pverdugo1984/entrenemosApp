{
  "version": 3,
  "sources": ["src/app/core/services/plan-usuario.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from \"@angular/core\";\r\nimport { HttpClient } from \"@angular/common/http\";\r\nimport { Observable, of, throwError } from \"rxjs\";\r\nimport { map, catchError } from \"rxjs/operators\";\r\nimport { API_BASE_URL } from \"../../config/api.config\";\r\nimport {\r\n  PlanUsuario,\r\n  PlanDisponible,\r\n} from \"../../shared/models/plan-usuario.model\";\r\nimport { Entrenamiento } from \"../../shared/models/entrenamiento.model\";\r\n\r\n@Injectable({\r\n  providedIn: \"root\",\r\n})\r\nexport class PlanUsuarioService {\r\n  private http = inject(HttpClient);\r\n  private apiUrl = `${API_BASE_URL}/plan-usuario`;\r\n\r\n  /**\r\n   * Asignar un plan de entrenamiento a un usuario\r\n   */\r\n  asignarPlan(\r\n    usuarioId: number,\r\n    entrenamientoId: number\r\n  ): Observable<PlanUsuario> {\r\n    return this.http.post<PlanUsuario>(this.apiUrl, {\r\n      usuarioId,\r\n      entrenamientoId,\r\n      fechaInicio: new Date().toISOString().split(\"T\")[0],\r\n      activo: true,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Obtener el plan activo de un usuario\r\n   */\r\n  obtenerPlanActivo(usuarioId: number): Observable<PlanUsuario | null> {\r\n    return this.http\r\n      .get<PlanUsuario | null>(`${this.apiUrl}/usuario/${usuarioId}/activo`)\r\n      .pipe(\r\n        catchError((error) => {\r\n          // Si el endpoint no existe o hay error, retornar null\r\n          // Esto permite que el frontend use localStorage como fallback\r\n          console.warn(\"Error obteniendo plan activo del backend:\", error);\r\n          return of(null);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Obtener todos los planes de un usuario\r\n   */\r\n  obtenerPlanesUsuario(usuarioId: number): Observable<PlanUsuario[]> {\r\n    return this.http.get<PlanUsuario[]>(`${this.apiUrl}/usuario/${usuarioId}`);\r\n  }\r\n\r\n  /**\r\n   * Marcar un ejercicio como completado\r\n   */\r\n  marcarEjercicioCompletado(\r\n    planUsuarioId: number,\r\n    ejercicioId: number\r\n  ): Observable<PlanUsuario> {\r\n    return this.http\r\n      .post<PlanUsuario>(\r\n        `${this.apiUrl}/${planUsuarioId}/ejercicio/${ejercicioId}/completar`,\r\n        {}\r\n      )\r\n      .pipe(\r\n        catchError((error) => {\r\n          // Si el endpoint no existe, lanzar error para que el componente maneje el fallback\r\n          console.warn(\r\n            \"Error marcando ejercicio completado en backend:\",\r\n            error\r\n          );\r\n          return throwError(() => error);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Finalizar un plan\r\n   */\r\n  finalizarPlan(planUsuarioId: number): Observable<PlanUsuario> {\r\n    return this.http.put<PlanUsuario>(\r\n      `${this.apiUrl}/${planUsuarioId}/finalizar`,\r\n      {}\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Obtener planes disponibles (todos los entrenamientos)\r\n   * Esto es una función helper que usa el EntrenamientoService\r\n   */\r\n  obtenerPlanesDisponibles(): Observable<PlanDisponible[]> {\r\n    // Por ahora, convertimos todos los entrenamientos en planes disponibles\r\n    // En el futuro, esto podría venir de un endpoint específico\r\n    return this.http\r\n      .get<Entrenamiento[]>(`${API_BASE_URL}/entrenamientos`)\r\n      .pipe(\r\n        map((entrenamientos) => {\r\n          return entrenamientos.map((ent) => {\r\n            let duracionDias = 7; // Por defecto\r\n            if (ent.fechaInicio && ent.fechaFin) {\r\n              const inicio = new Date(ent.fechaInicio);\r\n              const fin = new Date(ent.fechaFin);\r\n              duracionDias = Math.ceil(\r\n                (fin.getTime() - inicio.getTime()) / (1000 * 60 * 60 * 24)\r\n              );\r\n            }\r\n\r\n            // Estimar dificultad basada en número de ejercicios\r\n            let dificultad: \"Principiante\" | \"Intermedio\" | \"Avanzado\" =\r\n              \"Principiante\";\r\n            const numEjercicios = ent.ejerciciosIds?.length || 0;\r\n            if (numEjercicios <= 3) {\r\n              dificultad = \"Principiante\";\r\n            } else if (numEjercicios <= 6) {\r\n              dificultad = \"Intermedio\";\r\n            } else {\r\n              dificultad = \"Avanzado\";\r\n            }\r\n\r\n            return {\r\n              entrenamiento: ent,\r\n              duracionDias,\r\n              dificultad,\r\n              categoria: \"General\",\r\n            } as PlanDisponible;\r\n          });\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Calcular el progreso de un plan (porcentaje completado)\r\n   */\r\n  calcularProgreso(plan: PlanUsuario): number {\r\n    // Intentar usar ejercicios cargados primero\r\n    if (\r\n      plan.entrenamiento?.ejercicios &&\r\n      plan.entrenamiento.ejercicios.length > 0\r\n    ) {\r\n      const ejerciciosCompletados = plan.ejerciciosCompletados?.length || 0;\r\n      const totalEjercicios = plan.entrenamiento.ejercicios.length;\r\n      return Math.round((ejerciciosCompletados / totalEjercicios) * 100);\r\n    }\r\n\r\n    // Si no hay ejercicios cargados, usar IDs\r\n    if (\r\n      plan.entrenamiento?.ejerciciosIds &&\r\n      plan.entrenamiento.ejerciciosIds.length > 0\r\n    ) {\r\n      const ejerciciosCompletados = plan.ejerciciosCompletados?.length || 0;\r\n      const totalEjercicios = plan.entrenamiento.ejerciciosIds.length;\r\n      return Math.round((ejerciciosCompletados / totalEjercicios) * 100);\r\n    }\r\n\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Verificar si un ejercicio está completado\r\n   */\r\n  esEjercicioCompletado(plan: PlanUsuario, ejercicioId: number): boolean {\r\n    return plan.ejerciciosCompletados?.includes(ejercicioId) || false;\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAcM,IAAO,qBAAP,MAAO,oBAAkB;EACrB,OAAO,OAAO,UAAU;EACxB,SAAS,GAAG,YAAY;;;;EAKhC,YACE,WACA,iBAAuB;AAEvB,WAAO,KAAK,KAAK,KAAkB,KAAK,QAAQ;MAC9C;MACA;MACA,cAAa,oBAAI,KAAI,GAAG,YAAW,EAAG,MAAM,GAAG,EAAE,CAAC;MAClD,QAAQ;KACT;EACH;;;;EAKA,kBAAkB,WAAiB;AACjC,WAAO,KAAK,KACT,IAAwB,GAAG,KAAK,MAAM,YAAY,SAAS,SAAS,EACpE,KACC,WAAW,CAAC,UAAS;AAGnB,cAAQ,KAAK,6CAA6C,KAAK;AAC/D,aAAO,GAAG,IAAI;IAChB,CAAC,CAAC;EAER;;;;EAKA,qBAAqB,WAAiB;AACpC,WAAO,KAAK,KAAK,IAAmB,GAAG,KAAK,MAAM,YAAY,SAAS,EAAE;EAC3E;;;;EAKA,0BACE,eACA,aAAmB;AAEnB,WAAO,KAAK,KACT,KACC,GAAG,KAAK,MAAM,IAAI,aAAa,cAAc,WAAW,cACxD,CAAA,CAAE,EAEH,KACC,WAAW,CAAC,UAAS;AAEnB,cAAQ,KACN,mDACA,KAAK;AAEP,aAAO,WAAW,MAAM,KAAK;IAC/B,CAAC,CAAC;EAER;;;;EAKA,cAAc,eAAqB;AACjC,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,IAAI,aAAa,cAC/B,CAAA,CAAE;EAEN;;;;;EAMA,2BAAwB;AAGtB,WAAO,KAAK,KACT,IAAqB,GAAG,YAAY,iBAAiB,EACrD,KACC,IAAI,CAAC,mBAAkB;AACrB,aAAO,eAAe,IAAI,CAAC,QAAO;AAChC,YAAI,eAAe;AACnB,YAAI,IAAI,eAAe,IAAI,UAAU;AACnC,gBAAM,SAAS,IAAI,KAAK,IAAI,WAAW;AACvC,gBAAM,MAAM,IAAI,KAAK,IAAI,QAAQ;AACjC,yBAAe,KAAK,MACjB,IAAI,QAAO,IAAK,OAAO,QAAO,MAAO,MAAO,KAAK,KAAK,GAAG;QAE9D;AAGA,YAAI,aACF;AACF,cAAM,gBAAgB,IAAI,eAAe,UAAU;AACnD,YAAI,iBAAiB,GAAG;AACtB,uBAAa;QACf,WAAW,iBAAiB,GAAG;AAC7B,uBAAa;QACf,OAAO;AACL,uBAAa;QACf;AAEA,eAAO;UACL,eAAe;UACf;UACA;UACA,WAAW;;MAEf,CAAC;IACH,CAAC,CAAC;EAER;;;;EAKA,iBAAiB,MAAiB;AAEhC,QACE,KAAK,eAAe,cACpB,KAAK,cAAc,WAAW,SAAS,GACvC;AACA,YAAM,wBAAwB,KAAK,uBAAuB,UAAU;AACpE,YAAM,kBAAkB,KAAK,cAAc,WAAW;AACtD,aAAO,KAAK,MAAO,wBAAwB,kBAAmB,GAAG;IACnE;AAGA,QACE,KAAK,eAAe,iBACpB,KAAK,cAAc,cAAc,SAAS,GAC1C;AACA,YAAM,wBAAwB,KAAK,uBAAuB,UAAU;AACpE,YAAM,kBAAkB,KAAK,cAAc,cAAc;AACzD,aAAO,KAAK,MAAO,wBAAwB,kBAAmB,GAAG;IACnE;AAEA,WAAO;EACT;;;;EAKA,sBAAsB,MAAmB,aAAmB;AAC1D,WAAO,KAAK,uBAAuB,SAAS,WAAW,KAAK;EAC9D;;qCAxJW,qBAAkB;EAAA;4EAAlB,qBAAkB,SAAlB,oBAAkB,WAAA,YAFjB,OAAM,CAAA;;;sEAEP,oBAAkB,CAAA;UAH9B;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
