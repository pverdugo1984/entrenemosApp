<div class="page-wrapper">
    <app-header />
    <div class="page-container">
        <h1>Planes de Entrenamiento</h1>

        <!-- Selector de vista -->
        <div class="vista-selector">
            <button class="vista-btn" [class.activo]="vistaSeleccionada === 'mi-plan'"
                (click)="cambiarVista('mi-plan')">
                üéØ Mi Plan
            </button>
            <button class="vista-btn" [class.activo]="vistaSeleccionada === 'disponibles'"
                (click)="cambiarVista('disponibles')">
                üìã Disponibles
            </button>
        </div>

        <!-- Estado de carga -->
        @if (cargando) {
        <div class="estado-carga">
            <div class="spinner"></div>
            <p>‚è≥ Cargando...</p>
        </div>
        }

        <!-- Mensaje de error -->
        @if (error && !cargando) {
        <div class="error-message">
            <p>‚ùå {{ error }}</p>
        </div>
        }

        <!-- Vista: Planes Disponibles -->
        @if (!cargando && !error && vistaSeleccionada === 'disponibles') {
        <div class="planes-container">
            @if (planesDisponibles.length === 0) {
            <div class="sin-planes">
                <p>üì≠ No hay planes disponibles en este momento</p>
            </div>
            }

            @for (plan of planesDisponibles; track plan.entrenamiento.id) {
            <div class="plan-card" [class.plan-activo-marcado]="esPlanActivo(plan)">
                <div class="plan-header">
                    <div class="plan-header-content" style="cursor: pointer;" (click)="verDetallePlan(plan.entrenamiento.id)">
                        <img [src]="getImagenUrl(plan.entrenamiento)" [alt]="plan.entrenamiento.nombre" class="plan-imagen-mini" />
                        <h2 class="plan-nombre">{{ plan.entrenamiento.nombre }}</h2>
                    </div>
                    <div class="plan-badges">
                        @if (esPlanActivo(plan)) {
                        <span class="plan-activo-indicador">‚úÖ Activo</span>
                        }
                        @if (plan.dificultad) {
                        <span class="dificultad-badge" [class]="plan.dificultad.toLowerCase()">
                            {{ plan.dificultad }}
                        </span>
                        }
                    </div>
                </div>

                @if (plan.entrenamiento.descripcion) {
                <p class="plan-descripcion">{{ plan.entrenamiento.descripcion }}</p>
                }

                <div class="plan-info">
                    <div class="info-item">
                        <span class="info-icon">üìÖ</span>
                        <span class="info-text">{{ plan.duracionDias }} d√≠as</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üèãÔ∏è</span>
                        <span class="info-text">
                            {{ plan.entrenamiento.ejercicios?.length || plan.entrenamiento.ejerciciosIds?.length || 0 }}
                            ejercicios
                        </span>
                    </div>
                </div>

                <button class="btn-seleccionar" (click)="seleccionarPlan(plan)"
                    [disabled]="asignando || !usuario || !usuario.id || esPlanActivo(plan)">
                    @if (asignando) {
                    <span>‚è≥ Asignando...</span>
                    } @else if (!usuario || !usuario.id) {
                    <span>‚è≥ Cargando usuario...</span>
                    } @else if (esPlanActivo(plan)) {
                    <span>‚úÖ Plan Activo</span>
                    } @else {
                    <span>‚úÖ Seleccionar Plan</span>
                    }
                </button>
            </div>
            }
        </div>
        }

        <!-- Vista: Mi Plan Activo -->
        @if (!cargando && vistaSeleccionada === 'mi-plan') {
        <div class="mi-plan-container">
            <!-- Cron√≥metro WOD -->
            <app-wod-timer />

            <h2 class="seccion-titulo">Registra tu progreso</h2>

            <!-- Informaci√≥n del plan activo -->
            @if (tienePlanActivo) {
            <div class="plan-activo-info">
                <div class="plan-activo-header" (click)="verPlanActivo()" style="cursor: pointer;">
                    @if (planActivo?.entrenamiento?.imagen) {
                    <img [src]="getImagenUrl(planActivo?.entrenamiento || null)" [alt]="planActivo?.entrenamiento?.nombre || ''" class="plan-activo-imagen" />
                    }
                    <div class="plan-activo-header-content">
                        <h3>üéØ Plan Activo: {{ planActivo?.entrenamiento?.nombre || 'Cargando...' }}</h3>
                        <div class="progreso-plan">
                            <span class="progreso-texto">Progreso: {{ obtenerProgresoPlan() }}%</span>
                            <div class="progreso-bar-mini">
                                <div class="progreso-fill-mini" [style.width.%]="obtenerProgresoPlan()"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            } @else {
            <div class="sin-plan-info">
                <div class="sin-plan-mensaje">
                    <span class="sin-plan-icon">üéØ</span>
                    <p>No tienes un plan activo. Selecciona un plan para comenzar a registrar tu progreso.</p>
                    <button class="btn-seleccionar-plan" (click)="cambiarVista('disponibles')">Seleccionar Plan</button>
                </div>
            </div>
            }

            <!-- Mensaje de √©xito -->
            @if (exito) {
            <div class="mensaje-exito">
                <p>‚úÖ ¬°Progreso registrado correctamente!</p>
            </div>
            }

            <!-- Mensaje de error -->
            @if (error) {
            <div class="mensaje-error">
                <p>‚ùå {{ error }}</p>
            </div>
            }

            <!-- Formulario de registro -->
            <form class="formulario-progreso" (ngSubmit)="registrarProgreso()">
                <div class="campo-formulario">
                    <div class="label-with-video">
                        <label for="ejercicio">Ejercicio</label>
                        @if (ejercicioSeleccionado?.videoUrl) {
                        <a [href]="ejercicioSeleccionado?.videoUrl" target="_blank" class="video-url-link" title="Abrir video">
                            üé• Ver video
                        </a>
                        }
                    </div>
                    @if (tienePlanActivo) {
                    <select id="ejercicio" class="campo-input" [(ngModel)]="ejercicioSeleccionadoId" name="ejercicio"
                        [disabled]="guardando || cargando" required>
                        <option [value]="null">Selecciona un ejercicio</option>
                        @for (ejercicio of ejerciciosDisponibles; track ejercicio.id) {
                        <option [value]="ejercicio.id">
                            {{ ejercicio.nombre }}
                            @if (esEjercicioCompletado(ejercicio.id!)) {
                            ‚úÖ
                            }
                        </option>
                        }
                    </select>
                    } @else {
                    <select id="ejercicio" class="campo-input" disabled>
                        <option [value]="null">Selecciona plan</option>
                    </select>
                    <p class="ayuda-texto">‚ö†Ô∏è Necesitas tener un plan activo para registrar ejercicios</p>
                    }
                    @if (planActivo && ejerciciosDelPlan.length === 0) {
                    <p class="ayuda-texto">‚ö†Ô∏è El plan activo no tiene ejercicios asignados</p>
                    }
                </div>

                <div class="campo-formulario">
                    <label for="fecha">Fecha</label>
                    <input type="date" id="fecha" class="campo-input" [(ngModel)]="fecha" name="fecha"
                        [disabled]="guardando" required />
                </div>

                <div class="metricas-grid">
                    <div class="campo-formulario">
                        <label for="peso">Peso (kg)</label>
                        <input type="number" id="peso" class="campo-input" [(ngModel)]="peso" name="peso"
                            placeholder="0" step="0.1" min="0" [disabled]="guardando" />
                    </div>

                    <div class="campo-formulario">
                        <label for="repeticiones">Repeticiones</label>
                        <input type="number" id="repeticiones" class="campo-input" [(ngModel)]="repeticiones"
                            name="repeticiones" placeholder="0" min="0" [disabled]="guardando" />
                    </div>

                    <div class="campo-formulario">
                        <label for="tiempo">Tiempo (seg)</label>
                        <input type="number" id="tiempo" class="campo-input" [(ngModel)]="tiempo" name="tiempo"
                            placeholder="0" step="0.1" min="0" [disabled]="guardando" />
                    </div>
                </div>

                <button type="submit" class="boton-guardar" [disabled]="guardando">
                    @if (!guardando) {
                    <span>üíæ Guardar Progreso</span>
                    }
                    @if (guardando) {
                    <span>‚è≥ Guardando...</span>
                    }
                </button>
            </form>
        </div>
        }
    </div>
    <app-bottom-nav />
</div>