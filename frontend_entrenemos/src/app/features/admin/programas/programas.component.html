<div class="programas-admin-container">
    <!-- Secci√≥n de Programas -->
    <div class="programas-section">
        <div class="header-section">
            <h1>Gesti√≥n de Programas de Entrenamiento</h1>
            <button class="btn-nuevo" (click)="abrirFormulario()">
                ‚ûï Nuevo Programa
            </button>
        </div>

        <!-- Mensaje de error -->
        @if (error) {
        <div class="error-message">
            <p>‚ùå {{ error }}</p>
        </div>
        }

        <!-- Estado de carga -->
        @if (cargando && entrenamientos.length === 0) {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando programas...</p>
        </div>
        }

        <!-- Lista de entrenamientos -->
        @if (!cargando || entrenamientos.length > 0) {
        <div class="entrenamientos-grid">
            @for (entrenamiento of entrenamientos; track entrenamiento.id) {
            <div class="entrenamiento-card">
                <div class="entrenamiento-imagen-container" (click)="onImagenClick($event, entrenamiento)">
                    <img [src]="getImagenUrl(entrenamiento)" alt="{{ entrenamiento.nombre }}" 
                         class="entrenamiento-imagen" />
                    <div class="imagen-overlay">
                        <span class="imagen-edit-icon">üì∑ Cambiar imagen</span>
                    </div>
                </div>
                <div class="card-header">
                    <h3 class="entrenamiento-nombre">{{ entrenamiento.nombre }}</h3>
                    <div class="card-actions">
                        <button class="btn-editar" (click)="abrirFormulario(entrenamiento)">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn-eliminar" (click)="eliminar(entrenamiento.id!)">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>

                @if (entrenamiento.descripcion) {
                <p class="entrenamiento-descripcion">{{ entrenamiento.descripcion }}</p>
                }

                <div class="entrenamiento-info">
                    <div class="info-item">
                        <span class="info-label">üìÖ Inicio:</span>
                        <span class="info-value">{{ formatearFecha(entrenamiento.fechaInicio) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üìÖ Fin:</span>
                        <span class="info-value">{{ formatearFecha(entrenamiento.fechaFin) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üèãÔ∏è Ejercicios:</span>
                        <span class="info-value">
                            {{ entrenamiento.ejerciciosIds?.length || entrenamiento.ejercicios?.length || 0 }}
                        </span>
                    </div>
                </div>
            </div>
            }

            @if (entrenamientos.length === 0) {
            <div class="sin-entrenamientos">
                <p>üì≠ No hay programas de entrenamiento creados</p>
                <button class="btn-nuevo" (click)="abrirFormulario()">
                    Crear el primero
                </button>
            </div>
            }
        </div>
        }

        <!-- Modal de formulario -->
        @if (mostrarFormulario) {
        <div class="modal-overlay" (click)="cerrarFormulario()">
            <div class="modal-content" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h2>{{ editando ? "‚úèÔ∏è Editar Programa" : "‚ûï Nuevo Programa" }}</h2>
                    <button class="btn-cerrar" (click)="cerrarFormulario()">‚úï</button>
                </div>

                <form class="formulario" (ngSubmit)="guardar()">
                    <div class="form-group">
                        <label for="nombre">Nombre del Programa *</label>
                        <input type="text" id="nombre" [(ngModel)]="entrenamientoForm.nombre" name="nombre" required
                            placeholder="Ej: Plan de Fuerza 4 Semanas" />
                    </div>

                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n</label>
                        <textarea id="descripcion" [(ngModel)]="entrenamientoForm.descripcion" name="descripcion"
                            rows="3" placeholder="Describe el programa de entrenamiento..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fechaInicio">Fecha de Inicio</label>
                            <input type="date" id="fechaInicio" [(ngModel)]="entrenamientoForm.fechaInicio"
                                name="fechaInicio" />
                        </div>

                        <div class="form-group">
                            <label for="fechaFin">Fecha de Fin</label>
                            <input type="date" id="fechaFin" [(ngModel)]="entrenamientoForm.fechaFin" name="fechaFin" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ejercicios del Programa</label>
                        <div class="ejercicios-list">
                            @if (ejercicios.length === 0) {
                            <p class="sin-ejercicios">No hay ejercicios disponibles. Crea ejercicios primero.</p>
                            } @else {
                            @for (ejercicio of ejercicios; track ejercicio.id) {
                            <label class="ejercicio-checkbox">
                                <input type="checkbox" [checked]="estaSeleccionado(ejercicio.id!)"
                                    (change)="toggleEjercicio(ejercicio.id!)" />
                                <span class="ejercicio-info">
                                    <span class="ejercicio-nombre">{{ ejercicio.nombre }}</span>
                                    @if (ejercicio.tipo) {
                                    <span class="ejercicio-tipo">{{ ejercicio.tipo }}</span>
                                    }
                                </span>
                            </label>
                            }
                            }
                        </div>
                        <p class="ejercicios-seleccionados">
                            {{ ejerciciosSeleccionados.length }} ejercicio(s) seleccionado(s)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>Atletas Asignados al Programa</label>
                        <div class="ejercicios-list">
                            @if (atletas.length === 0) {
                            <p class="sin-ejercicios">No hay atletas disponibles.</p>
                            } @else {
                            @for (atleta of atletas; track atleta.id) {
                            <label class="ejercicio-checkbox">
                                <input type="checkbox" [checked]="estaAtletaSeleccionado(atleta.id)"
                                    (change)="toggleAtleta(atleta.id)" />
                                <span class="ejercicio-info">
                                    <span class="ejercicio-nombre">{{ atleta.nombre }}</span>
                                    @if (atleta.email) {
                                    <span class="ejercicio-tipo">{{ atleta.email }}</span>
                                    }
                                </span>
                            </label>
                            }
                            }
                        </div>
                        <p class="ejercicios-seleccionados">
                            {{ atletasSeleccionados.length }} atleta(s) seleccionado(s)
                        </p>
                    </div>

                    @if (authService.getRol() === 'ADMIN') {
                    <div class="form-group">
                        <label>Entrenadores Asignados al Programa</label>
                        <div class="ejercicios-list">
                            @if (entrenadores.length === 0) {
                            <p class="sin-ejercicios">No hay entrenadores disponibles.</p>
                            } @else {
                            @for (entrenador of entrenadores; track entrenador.id) {
                            <label class="ejercicio-checkbox">
                                <input type="checkbox" [checked]="estaEntrenadorSeleccionado(entrenador.id)"
                                    (change)="toggleEntrenador(entrenador.id)" />
                                <span class="ejercicio-info">
                                    <span class="ejercicio-nombre">{{ entrenador.nombre }}</span>
                                    @if (entrenador.email) {
                                    <span class="ejercicio-tipo">{{ entrenador.email }}</span>
                                    }
                                </span>
                            </label>
                            }
                            }
                        </div>
                        <p class="ejercicios-seleccionados">
                            {{ entrenadoresSeleccionados.length }} entrenador(es) seleccionado(s)
                        </p>
                    </div>
                    }

                    <div class="form-actions">
                        <button type="button" class="btn-cancelar" (click)="cerrarFormulario()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-guardar" [disabled]="cargando">
                            @if (cargando) {
                            <span>‚è≥ Guardando...</span>
                            } @else {
                            <span>{{ editando ? "üíæ Actualizar" : "‚úÖ Crear" }}</span>
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>
        }

        <!-- Modal de formulario de ejercicio -->
        @if (mostrarFormularioEjercicio) {
        <div class="modal-overlay" (click)="cerrarFormularioEjercicio()">
            <div class="modal-content" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h2>{{ editandoEjercicio ? "‚úèÔ∏è Editar Ejercicio" : "‚ûï Nuevo Ejercicio" }}</h2>
                    <button class="btn-cerrar" (click)="cerrarFormularioEjercicio()">‚úï</button>
                </div>

                <form class="formulario" (ngSubmit)="guardarEjercicio()">
                    <div class="form-group">
                        <label for="ejercicio-nombre">Nombre del Ejercicio *</label>
                        <input type="text" id="ejercicio-nombre" [(ngModel)]="ejercicioForm.nombre"
                            name="ejercicio-nombre" required placeholder="Ej: Press de Banca" />
                    </div>

                    <div class="form-group">
                        <label for="ejercicio-descripcion">Descripci√≥n</label>
                        <textarea id="ejercicio-descripcion" [(ngModel)]="ejercicioForm.descripcion"
                            name="ejercicio-descripcion" rows="3" placeholder="Describe el ejercicio..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ejercicio-tipo">Tipo</label>
                            <input type="text" id="ejercicio-tipo" [(ngModel)]="ejercicioForm.tipo"
                                name="ejercicio-tipo" placeholder="Ej: Fuerza, Cardio, Flexibilidad" />
                        </div>

                        <div class="form-group">
                            <label for="ejercicio-repeticiones">Repeticiones</label>
                            <input type="number" id="ejercicio-repeticiones" [(ngModel)]="ejercicioForm.repeticiones"
                                name="ejercicio-repeticiones" min="0" placeholder="Ej: 10" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ejercicio-peso">Peso (kg)</label>
                            <input type="number" id="ejercicio-peso" [(ngModel)]="ejercicioForm.peso"
                                name="ejercicio-peso" min="0" step="0.1" placeholder="Ej: 20.5" />
                        </div>

                        <div class="form-group">
                            <label for="ejercicio-videoUrl">URL del Video</label>
                            <input type="url" id="ejercicio-videoUrl" [(ngModel)]="ejercicioForm.videoUrl"
                                name="ejercicio-videoUrl" placeholder="https://..." />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Programas de Entrenamiento Asignados</label>
                        <div class="ejercicios-list">
                            @if (programasDisponibles.length === 0) {
                            <p class="sin-ejercicios">No hay programas disponibles.</p>
                            } @else {
                            @for (programa of programasDisponibles; track programa.id) {
                            <label class="ejercicio-checkbox">
                                <input type="checkbox" [checked]="estaProgramaSeleccionado(programa.id!)"
                                    (change)="toggleProgramaEjercicio(programa.id!)" />
                                <span class="ejercicio-info">
                                    <span class="ejercicio-nombre">{{ programa.nombre }}</span>
                                    @if (programa.descripcion) {
                                    <span class="ejercicio-tipo">{{ programa.descripcion }}</span>
                                    }
                                </span>
                            </label>
                            }
                            }
                        </div>
                        <p class="ejercicios-seleccionados">
                            {{ programasSeleccionadosEjercicio.length }} programa(s) seleccionado(s)
                        </p>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancelar" (click)="cerrarFormularioEjercicio()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-guardar" [disabled]="cargando">
                            @if (cargando) {
                            <span>‚è≥ Guardando...</span>
                            } @else {
                            <span>{{ editandoEjercicio ? "üíæ Actualizar" : "‚úÖ Crear" }}</span>
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>
        }
    </div>

    <!-- Secci√≥n de Ejercicios -->
    <div class="ejercicios-section">
        <div class="header-section">
            <h2>Gesti√≥n de Ejercicios</h2>
            <button class="btn-nuevo" (click)="abrirFormularioEjercicio()">
                ‚ûï Nuevo Ejercicio
            </button>
        </div>

        <!-- Tabla de ejercicios -->
        @if (ejercicios.length === 0) {
        <div class="sin-ejercicios-card">
            <p>üì≠ No hay ejercicios creados</p>
            <button class="btn-nuevo" (click)="abrirFormularioEjercicio()">
                Crear el primero
            </button>
        </div>
        } @else {
        <div class="ejercicios-table-container">
            <table class="ejercicios-table">
                <thead>
                    <tr>
                        <th class="sortable" (click)="ordenarPor('nombre')">
                            <span>Nombre</span>
                            <span class="sort-icon">{{ obtenerIconoOrden('nombre') }}</span>
                        </th>
                        <th class="sortable" (click)="ordenarPor('tipo')">
                            <span>Tipo</span>
                            <span class="sort-icon">{{ obtenerIconoOrden('tipo') }}</span>
                        </th>
                        <th class="sortable" (click)="ordenarPor('repeticiones')">
                            <span>Repeticiones</span>
                            <span class="sort-icon">{{ obtenerIconoOrden('repeticiones') }}</span>
                        </th>
                        <th class="sortable" (click)="ordenarPor('peso')">
                            <span>Peso (kg)</span>
                            <span class="sort-icon">{{ obtenerIconoOrden('peso') }}</span>
                        </th>
                        <th class="sortable" (click)="ordenarPor('planes')">
                            <span>Planes</span>
                            <span class="sort-icon">{{ obtenerIconoOrden('planes') }}</span>
                        </th>
                        <th class="sortable" (click)="ordenarPor('videoUrl')">
                            <span>Video URL</span>
                            <span class="sort-icon">{{ obtenerIconoOrden('videoUrl') }}</span>
                        </th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @for (ejercicio of ejerciciosOrdenados; track ejercicio.id) {
                    <tr>
                        <td class="ejercicio-nombre-cell">
                            <strong>{{ ejercicio.nombre }}</strong>
                            @if (ejercicio.descripcion) {
                            <span class="ejercicio-descripcion-table">{{ ejercicio.descripcion }}</span>
                            }
                        </td>
                        <td>
                            @if (ejercicio.tipo) {
                            <span class="ejercicio-tipo-badge">{{ ejercicio.tipo }}</span>
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (ejercicio.repeticiones) {
                            {{ ejercicio.repeticiones }}
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (ejercicio.peso) {
                            {{ ejercicio.peso }}
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (obtenerPlanesDelEjercicio(ejercicio.id!).length > 0) {
                            <div class="planes-tags">
                                @for (plan of obtenerPlanesDelEjercicio(ejercicio.id!); track plan.id) {
                                <span class="plan-tag">{{ plan.nombre }}</span>
                                }
                            </div>
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (ejercicio.videoUrl) {
                            <a [href]="ejercicio.videoUrl" target="_blank" class="video-url-link" title="Abrir video">
                                üé• Ver video
                            </a>
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td class="acciones-cell">
                            <button class="btn-editar-table" (click)="abrirFormularioEjercicio(ejercicio)"
                                title="Editar">
                                ‚úèÔ∏è
                            </button>
                            @if (authService.getRol() === 'ADMIN') {
                            <button class="btn-eliminar-table" (click)="eliminarEjercicio(ejercicio.id!)"
                                title="Eliminar">
                                üóëÔ∏è
                            </button>
                            }
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }

        <!-- Modal de formulario de ejercicio -->